#!/bin/sh

PRODUCT_DEVICE="netgate-rcc-ve-4860"

. /opnsense/data/common.conf

# target files
export CDROM="${IMAGESDIR}/${PRODUCT_RELEASE}-cdrom-netgate-rcc-ve-4860-${ARCH}.iso"
export SERIALIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-serial-netgate-rcc-ve-4860-${ARCH}.img"
export VGAIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-vga-netgate-rcc-ve-4860-${ARCH}.img"
export NANOIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-nano-netgate-rcc-ve-4860-${ARCH}.img"

memstick_populate_hook() {
	sed -i '' -Ee 's:^ttyu0:ttyu0	"/usr/libexec/getty std.115200"	vt100	on  secure:' ${STAGEDIR}/etc/ttys
	sed -i '' -Ee 's:^ttyu1:ttyu1	"/usr/libexec/getty std.115200"	vt100	on  secure:' ${STAGEDIR}/etc/ttys

	echo 'hint.uart.0.flags=0x0' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'hint.uart.1.flags=0x10' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'comconsole_speed="115200"' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'comconsole_port="0x2F8"' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'console="comconsole"' >> ${STAGEDIR}/boot/loader.conf.local
}

filesystem_populate_hook() {
	echo 'hardening.log.log=0' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'secadm_load="YES"' >> ${STAGEDIR}/boot/loader.conf.local

	cat <<EOF >> ${STAGEDIR}/usr/local/etc/secadm.rules
{
	applications: [
		{
			path: "/usr/local/bin/suricata",
			features: {
				mprotect: false,
				pageexec: false
			}
		}
	]
}
EOF
}
