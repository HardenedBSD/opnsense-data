#!/bin/sh

set -e

# important build settings
export PRODUCT_VERSION="15.1-hbsd-exp-01"
export PRODUCT_FLAVOUR=${PRODUCT_FLAVOUR:-"OPNSense-OpenSSL"}
export PRODUCT_NAME="HardenedBSD"
export INTEGRIFORCE="YES"

# full name for easy use
export PRODUCT_RELEASE="${PRODUCT_NAME}-${PRODUCT_VERSION}_${PRODUCT_FLAVOUR}"

# code reositories
export TOOLSDIR="/usr/tools"
export PORTSDIR="/usr/ports"
export COREDIR="/usr/core"
export SRCDIR="/usr/src"

# misc. foo
export CONFIG_PKG="/usr/local/etc/pkg/repos/${PRODUCT_NAME}.conf"
export CPUS=$(sysctl kern.smp.cpus | awk '{ print $2 }')
export CONFIG_XML="/usr/local/etc/config.xml"
export ARCH=${ARCH:-$(uname -m)}
export LABEL=${PRODUCT_NAME}
export TARGET_ARCH=${ARCH}
export TARGETARCH=${ARCH}

# define target directories
export PACKAGESDIR="/packages"
export STAGEDIR="/usr/local/stage"
export IMAGESDIR="/tmp/images"
export SETSDIR="/tmp/sets"

# bootstrap target directories
mkdir -p ${STAGEDIR} ${IMAGESDIR} ${SETSDIR}

export BUILD_KERNEL="NOSMP-HARDENEDBSD"

# target files
export CDROM="${IMAGESDIR}/${PRODUCT_RELEASE}-cdrom-netgate-rcc-ve-4860-${ARCH}.iso"
export SERIALIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-serial-netgate-rcc-ve-4860-${ARCH}.img"
export VGAIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-vga-netgate-rcc-ve-4860-${ARCH}.img"
export NANOIMG="${IMAGESDIR}/${PRODUCT_RELEASE}-nano-netgate-rcc-ve-4860-${ARCH}.img"

export MAKEOBJDIRPREFIX="/usr/obj/opnsense"

memstick_populate_hook() {
	sed -i '' -Ee 's:^ttyu0:ttyu0	"/usr/libexec/getty std.115200"	vt100	on  secure:' ${STAGEDIR}/etc/ttys
	sed -i '' -Ee 's:^ttyu1:ttyu1	"/usr/libexec/getty std.115200"	vt100	on  secure:' ${STAGEDIR}/etc/ttys

	echo 'hint.uart.0.flags=0x0' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'hint.uart.1.flags=0x10' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'comconsole_speed="115200"' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'comconsole_port="0x2F8"' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'console="comconsole"' >> ${STAGEDIR}/boot/loader.conf.local
}

filesystem_populate_hook() {
	echo 'hardening.log.log=0' >> ${STAGEDIR}/boot/loader.conf.local
	echo 'secadm_load="YES"' >> ${STAGEDIR}/boot/loader.conf.local
}
